pipeline {
    agent any
    environment {
        registry = credentials('docker_hub_registry')
        registryCredential = credentials('docker_hub')
    }
    stages {
	    stage('Run Docker and login') {
            steps {
                bat 'docker run'
            }
        }
        stage('Build Docker Image') {
            steps {
                bat 'docker build -t %registry%:%BUILD_NUMBER% .'
            }
        }
	stage('Push Docker Image to Hub') {
            steps {
		bat 'docker login -u %registryCredential_USR% -p %registryCredential_PSW%'
		bat 'docker push %registry%:%BUILD_NUMBER%'
            }
        }
        stage('Clean environment') {
            steps {
                bat 'python clean_environment.py'
            }
        }
    }
        post{
         always{
         bat "docker rmi %registry%:%BUILD_NUMBER%"
         }
     }
}
