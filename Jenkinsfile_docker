pipeline {
    agent any
    environment {
        registry = credentials('docker_hub_registry')
        registryCredential = credentials('docker_hub')
    }
    stages {
        stage('Build Docker Image') {
            steps {
                bat 'docker build -t %registry%:%BUILD_NUMBER% .'
            }
        }
	stage('Push Docker Image to Hub') {
            steps {
		bat 'docker login -u %registryCredential_USR% -p %registryCredential_PSW%'
		bat 'docker push %registry%:%BUILD_NUMBER%'
            }
        }
	stage('Set version') {
            steps {
                bat "(echo VERSION=%BUILD_NUMBER% & echo REGISTRY=%registry%) > .env"
            }
        }
	stage('Docker compose up') {
            steps {
                bat "docker-compose up -d"
            }
        }
        stage('Clean environment') {
            steps {
			    bat 'docker-compose down'
                bat 'python clean_environment.py'
            }
        }
    }
        post{
         always{
         bat "docker rmi %registry%:%BUILD_NUMBER%"
         }
     }
}
